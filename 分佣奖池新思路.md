## 分佣奖池新思路

1.新旧统计方式对比

|                  | 旧版本                         | 新版本                                                       |
| ---------------- | ------------------------------ | ------------------------------------------------------------ |
| 统计人数门槛     | 注册就纳入人数                 | 消费满298才纳入人数                                          |
| 监听系统时间     | 监听新用户注册事件             | 监听用户支付事件                                             |
| 获取分销关系方式 | 通过查询siteuser表确定分销关系 | 不论当月系新增人数纳入的门槛如何限制，分销关系始终还是不变。 |

2.需要调整的位置

1）取消用户注册的监听事件

2）增加订单完成的监听，主要逻辑判断如下：

- 判断订单用户是否为当月新增用户，如果不是，直接返回。
- 判断订单用户当月总消费金额是否满298，如果不满，直接返回。
- 判断订单用户是否有上级用户，如果有，则按照旧版的注册事件的流程走一遍，但原先为增加计数，现在为方便后续操作，计数后直接新建表以及相关的数据行。具体看3）

3）为了能够将用户信息显示在点击后的弹出层中，同时方便的进行后续更新，应当新增两个数据表

- 直系下级表
- 全部下级表

在本月新注册用户符合订单消费条件后，原先的操作时增加计数，但是目前的情况看来，应该在计数后增加该用户所有直系父级以及全部父级用户的相关数据行。

接下来就涉及到两个问题，首先分销中心需要显示的数字，可以通过查询两张表中对应用户根据created筛选当月的数据，同时获得count。以此做为计数显示即可。

当用户点击数字需要显示所有新增用户时，依然可以通过上述方法查询出所有的新增下级用户。

4）每月统计发放奖励时，没有计数显得非常不方便。因此计数的环节依然需要保留。直接查询计数表发放奖励





新增需求

- [ ] 1.剩余天数的位置替换为该用户历史总计全部下级用户。

- [x] 2.奖池发放记录的两个管理界面中，除显示分享奖池人数以外，应当增加查看分享人的功能。

- [x] 3.用户表中显示当前用户是否通过审核。

- [x] 4.用户表中增加两个筛选功能：根据选择奖池筛选，根据审核状态筛选。

- [x] 5.分支奖池分发记录表中，顶级分销商需要显示头像以及昵称

